name: Status Check - Backend Pull Request Build

on:
    pull_request:
        branches:
          - develop
          - main
          - 'release/**'
        paths:
          - src/weather-forecast-api/**
    workflow_dispatch:  # allows manual testing

jobs:
  backend-buildCheck:
    uses: ./.github/workflows/ci-template.yml
    name: Backend Status Check - Try package docker image
    with:
        service_name: weather-forecast-api
        gitversion_config_path: src/weather-forecast-api/GitVersion.yml
        #status check doesn't push into ACR
        push_to_registry: false
        service_path: src/weather-forecast-api
    secrets:
        ACR_LOGIN_SERVER: ${{ secrets.ACR_LOGIN_SERVER }}
        ACR_PASSWORD : ${{ secrets.ACR_PASSWORD }}
        ACR_USERNAME: ${{ secrets.ACR_USERNAME }}

    # Run unit tests
  run-UnitTests:
      runs-on: ubuntu-latest
      name: Backend Status Check - Run Unit Tests
      steps:
        - name: Checkout repo
          uses: actions/checkout@v4
          with:
          # shallow copy
            fetch-depth: 1

        - name: Restore Backend dependencies
          run: |
            dotnet restore src/weather-forecast-api/Tests/WeatherForecast.Tests.csproj
          
        - name: Run unit tests
          working-directory: src/weather-forecast-api/Tests
          run: |
                 dotnet test \
                    --configuration Release \
                    --logger "trx;LogFileName=backend-tests.trx" \
                    --collect:"XPlat Code Coverage" \
                    /p:CollectCoverage=true \
                    /p:CoverletOutputFormat=cobertura \
                    /p:CoverletOutput=TestResults/Coverage/

        - name: Upload backend test results
          uses: actions/upload-artifact@v4
          with:
            name: backend-test-results
            path: src/weather-forecast-api/TestResults
    